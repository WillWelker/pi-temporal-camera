//copy the line below to paste this flow inot Node Red using Import > Clipboard

[{"id":"15c2e4a4.8e4c5b","type":"exec","z":"532cf35c.1696ec","command":"sudo modprobe bcm2835-v4l2","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"modprobe bcm2835-v4l2","x":430,"y":160,"wires":[[],[],[]]},{"id":"e646d394.263cb","type":"inject","z":"532cf35c.1696ec","name":"On Start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"1","x":160,"y":160,"wires":[["15c2e4a4.8e4c5b"]]},{"id":"9014b47f.f63ba8","type":"ui_template","z":"532cf35c.1696ec","group":"1148bf05.e5e2d1","name":"Video Stream","order":3,"width":"12","height":"10","format":"<img name=\"main\" id=\"main\" border=\"0\" width=\"576\" height=\"432\" src=\"http://192.168.43.106:8081\">\nCTRL+ to zoom in, CTRL- to zoom out, F11 for full screen","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":800,"y":380,"wires":[[]]},{"id":"b495825c.db4a4","type":"inject","z":"532cf35c.1696ec","name":"record start time","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 06 * * *","once":false,"onceDelay":"1","x":130,"y":260,"wires":[["4f1af4a3.47d43c"]]},{"id":"4f1af4a3.47d43c","type":"exec","z":"532cf35c.1696ec","command":"rm /home/pi/.node-red/static/seq/*.jpg","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"clear images","x":390,"y":260,"wires":[[],[],[]]},{"id":"42aeffc4.4cab1","type":"ui_template","z":"532cf35c.1696ec","group":"f6c9c42a.29e7e8","name":"show gif","order":1,"width":"12","height":"10","format":"<img src=\"../gif/{{ msg.payload }}.gif\">\n\n<h3>\n   <a href=\"../gif/{{ msg.payload }}.gif\" download=\"time-shift.gif\">Download This GIF </a>|\n   <a href=\"../\" target=\"_blank\"> Node Settings</a>\n</h3>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":780,"y":480,"wires":[[]]},{"id":"24a4e1bd.9d795e","type":"comment","z":"532cf35c.1696ec","name":"For Pi Cameras","info":"These two nodes are only needed if you are\nuding a Raspberry Pi camera.  A USB cam\ndoes not need bcm2835-v4l2.\nMotion is designed to work with USB cameras,\nso the bcm2835-v4l2 module makes your Pi camera\nlook like a USB cam to the Motion Program.\nbcm2835-v4l2 needs to be activated at boot time.","x":160,"y":120,"wires":[]},{"id":"c817357.66d5cc8","type":"inject","z":"532cf35c.1696ec","name":"record stop time","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 18 * * *","once":false,"onceDelay":0.1,"x":130,"y":480,"wires":[["4686ab86.337234","2f7afc95.0edfd4"]]},{"id":"4686ab86.337234","type":"exec","z":"532cf35c.1696ec","command":"/home/pi/.node-red/make-gif.sh","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Make gif","x":380,"y":560,"wires":[["1dfe0f4a.53eee1","2e7a1259.651d9e"],[],[]]},{"id":"2f7afc95.0edfd4","type":"function","z":"532cf35c.1696ec","name":"gif name","func":"//Using the time stamp from the inject node,\n//a unique name is stored in a global variable\n//Using context store, this value is stored in\n//the file system to survive a reboot.\n\nvar gifName = msg.payload;\nglobal.set(\"gifName\",gifName,  \"default\");\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":480,"wires":[["c3cf9ee6.85504"]]},{"id":"1dfe0f4a.53eee1","type":"function","z":"532cf35c.1696ec","name":"name gif","func":"//After the gif script has completed,\n//the global variable is used to pass on the \n//gif name to the Template node for display\n\nvar gifName = global.get(\"gifName\");\nmsg.payload = gifName;\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":480,"wires":[["42aeffc4.4cab1"]]},{"id":"d2b30238.2c33","type":"comment","z":"532cf35c.1696ec","name":"Set Start Time to record gif","info":"Set the inject node to the time you want \nrecording to start.\nThe exec node will run command to clear all\nimages currently stored from motion snapshots.\nFor example 06:00 will clear all images and start\nsaving images from 6 AM","x":130,"y":220,"wires":[]},{"id":"66f8d66c.dd91f8","type":"inject","z":"532cf35c.1696ec","name":"every minute","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":680,"wires":[["4bff0a06.9ddcf4"]]},{"id":"4bff0a06.9ddcf4","type":"exec","z":"532cf35c.1696ec","command":"/home/pi/.node-red/count-images.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Count images","x":400,"y":680,"wires":[["eb0b350c.037a48"],[],[]]},{"id":"eb0b350c.037a48","type":"ui_text","z":"532cf35c.1696ec","group":"f6c9c42a.29e7e8","order":2,"width":"5","height":"1","name":"Image Count","label":"Image count for next GIF --","format":"{{msg.payload}}","layout":"row-spread","x":790,"y":660,"wires":[]},{"id":"3ab3632.341769c","type":"inject","z":"532cf35c.1696ec","name":"On Start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"1","x":160,"y":380,"wires":[["1dfe0f4a.53eee1"]]},{"id":"ae894ee6.729d3","type":"comment","z":"532cf35c.1696ec","name":"Set Stop Time to record gif","info":"Set the inject node to the time you want \nrecording to stop.\nThe exec node will run an exec command to to ceate \nan animated gif from all the images that have been \nstored.\n","x":110,"y":440,"wires":[]},{"id":"10a42c71.a1d8b4","type":"comment","z":"532cf35c.1696ec","name":"Push gif name","info":"In the event of a reboot a little extra push\nis needed to inject the gif name into the \ntemplate node.\nThis Inject node fires once on startup.","x":150,"y":340,"wires":[]},{"id":"a76e0813.4100b8","type":"comment","z":"532cf35c.1696ec","name":"Video Stream From Motion","info":"This template node has the HTML code to display\nthe live video stream from the motion program.\n","x":830,"y":340,"wires":[]},{"id":"f068c77f.1366f8","type":"comment","z":"532cf35c.1696ec","name":"Show GIF","info":"This template node has the HTML code to show\nthe animated gif.\nIt also contains code for a download link\nto save the current gif.","x":780,"y":440,"wires":[]},{"id":"478ca700.02a138","type":"comment","z":"532cf35c.1696ec","name":"make-gif.sh","info":"This exec node runs the shell script that\ndoes all the work with ffmpeg.\nThe time stamp from the inject node is passed\ninto the exec node which uses it to name\nthe gif that results.\nWhen complete it passes a message on to the\n'name gif' function node.  This node ignores\nany content of the message.  It is just triggered \nby the event to pass on the gif name to the\ntemplate node.\nThis can take a few minutes to run depending on how\nmany images you have.\n\nYou can get the bash script for this at:\nhttps://github.com/WillWelker/pi-temporal-camera/tree/master/bash\nThe script should be placed in your /.node-red/ directory.\nMake the script file executable.","x":370,"y":520,"wires":[]},{"id":"90d45c5.6ccdea","type":"comment","z":"532cf35c.1696ec","name":"Count Images","info":"Every minute, a bash script is triggered to count\nthe images that have been stored in \n/home/pi/.node-red/static/seq/\nAt the end of the script an 'echo' command\npasses the value back as a msg.payload which\ngoes to a Dashboard text node.\n\nYou can get the bash script for this at:\nhttps://github.com/WillWelker/pi-temporal-camera/blob/master/bash\nThe script should be placed in your /.node-red/ directory.\nMake the script file executable.","x":390,"y":640,"wires":[]},{"id":"dd51b13c.65b31","type":"ui_button","z":"532cf35c.1696ec","name":"","group":"f6c9c42a.29e7e8","order":2,"width":"4","height":"1","passthru":false,"label":"Make GIF now","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":140,"y":560,"wires":[["2f7afc95.0edfd4","4686ab86.337234"]]},{"id":"a400fb57.603628","type":"comment","z":"532cf35c.1696ec","name":"Dashboard button","info":"Dashboard button to make gif now with the images currenlty in the seq directory","x":130,"y":520,"wires":[]},{"id":"dd8f59f.eaed0a8","type":"ui_text","z":"532cf35c.1696ec","group":"f6c9c42a.29e7e8","order":2,"width":"3","height":"1","name":"Status","label":"Status:","format":"{{msg.payload}}","layout":"row-spread","x":770,"y":620,"wires":[]},{"id":"2e7a1259.651d9e","type":"change","z":"532cf35c.1696ec","name":"Done","rules":[{"t":"set","p":"payload","pt":"msg","to":"Done.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":620,"wires":[["dd8f59f.eaed0a8"]]},{"id":"c3cf9ee6.85504","type":"change","z":"532cf35c.1696ec","name":"Working","rules":[{"t":"set","p":"payload","pt":"msg","to":"Working...","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":580,"wires":[["dd8f59f.eaed0a8"]]},{"id":"e12e597c.e8f828","type":"comment","z":"532cf35c.1696ec","name":"Status","info":"These two change nodes set the text output to 'Working...'\nat the beginning of the gif process and then 'Done.'\nathe the end of the proccess.","x":590,"y":540,"wires":[]},{"id":"1148bf05.e5e2d1","type":"ui_group","z":"","name":"Live View","tab":"231a2b99.96e194","disp":true,"width":"12","collapse":false},{"id":"f6c9c42a.29e7e8","type":"ui_group","z":"","name":"Time Shift","tab":"231a2b99.96e194","order":2,"disp":true,"width":"12","collapse":false},{"id":"231a2b99.96e194","type":"ui_tab","z":"","name":"Main","icon":"dashboard"}]